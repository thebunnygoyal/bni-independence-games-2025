<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNI Independence Games 2.0 - Strategic Command Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        /* Navigation */
        .navbar {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-bottom: 2px solid #ffd700;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
        }
        
        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        
        .nav-links a:hover, .nav-links a.active {
            color: #ffd700;
        }
        
        /* Main Content */
        .main-content {
            margin-top: 80px;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Page Sections */
        .page-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .page-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Header */
        .hero-header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.3);
        }
        
        .hero-header h1 {
            font-size: 3.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero-header .subtitle {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .harvey-quote {
            font-style: italic;
            font-size: 1.1em;
            margin-top: 15px;
            opacity: 0.8;
        }
        
        /* Cards and Layouts */
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        .card h2, .card h3 {
            color: #ffd700;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2.2em;
            border-bottom: 3px solid #ffd700;
            padding-bottom: 15px;
        }
        
        /* Leaderboard */
        .chapter-row {
            display: grid;
            grid-template-columns: 60px 200px 1fr 120px 120px 120px 120px;
            gap: 20px;
            padding: 20px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid transparent;
        }
        
        .chapter-row:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .chapter-row.rank-1 {
            border-left-color: #ffd700;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(255, 255, 255, 0.08));
        }
        
        .chapter-row.rank-2 {
            border-left-color: #c0c0c0;
        }
        
        .chapter-row.rank-3 {
            border-left-color: #cd7f32;
        }
        
        .rank {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            text-align: center;
        }
        
        .chapter-name {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .victory-highlight {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .metric {
            text-align: center;
            font-weight: 600;
        }
        
        .metric.positive {
            color: #4ade80;
        }
        
        .metric.negative {
            color: #f87171;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .form-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffd700;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #ffd700, #d4af37);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 1em;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #4285f4, #1a73e8);
            color: #fff;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: #fff;
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            display: none;
        }
        
        .message-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #6ee7b7;
        }
        
        .message-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        /* Strategic Analysis */
        .strategy-panel {
            background: linear-gradient(135deg, #1e3a8a, #3730a3);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #ffd700;
        }
        
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .insight-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }
        
        .priority-critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .priority-high {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .priority-medium {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        /* Google Sheets Integration */
        .sheets-integration {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #4285f4;
        }
        
        .sheets-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #10b981;
        }
        
        .sheets-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .chapter-row {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .hero-header h1 {
                font-size: 2.5em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo">üèÜ BNI INDEPENDENCE GAMES 2.0</a>
            <div class="nav-links">
                <a href="#" onclick="showPage('leaderboard')" class="active">Leaderboard</a>
                <a href="#" onclick="showPage('tracking')">Chapter Tracking</a>
                <a href="#" onclick="showPage('analytics')">Strategic Analytics</a>
                <a href="#" onclick="showPage('sheets')">Data Management</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            
            <!-- Leaderboard Page -->
            <div id="leaderboard" class="page-section active">
                <div class="hero-header">
                    <h1>üéØ LIVE LEADERBOARD</h1>
                    <div class="subtitle">Real-Time Chapter Rankings - Independence Games 2.0</div>
                    <div class="harvey-quote">"Winners don't make excuses when the other side plays the game." - Harvey Specter</div>
                </div>

                <div class="card">
                    <h2>üìä Current Chapter Rankings</h2>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <span id="lastUpdate" style="color: #ffd700; font-weight: bold;">Last Updated: Loading...</span>
                        <button class="btn" onclick="refreshLeaderboard()">üîÑ Refresh Data</button>
                    </div>
                    
                    <div id="leaderboardContent">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>

                <div class="strategy-panel">
                    <h3 style="color: #ffd700; margin-bottom: 20px;">üéØ Victory's Current Position</h3>
                    <div id="victoryAnalysis">
                        <div class="insight-card priority-critical">
                            <strong>STRATEGIC STATUS:</strong> <span id="victoryStatus">Analyzing position...</span>
                        </div>
                        <div class="insight-card priority-high">
                            <strong>NEXT MOVES:</strong> <span id="nextMoves">Calculating optimal strategy...</span>
                        </div>
                        <div class="insight-card priority-medium">
                            <strong>COMPETITIVE EDGE:</strong> <span id="competitiveEdge">Evaluating advantages...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chapter Tracking Page -->
            <div id="tracking" class="page-section">
                <div class="hero-header">
                    <h1>üìà VICTORY CHAPTER TRACKER</h1>
                    <div class="subtitle">Command Center for Chapter Excellence</div>
                </div>

                <div class="card">
                    <h3>üìä Weekly Data Entry</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Week</label>
                            <select id="currentWeek" onchange="loadWeekData()">
                                <option value="1">Week 1 (June 17-23)</option>
                                <option value="2">Week 2 (June 24-30)</option>
                                <option value="3">Week 3 (July 1-7)</option>
                                <option value="4">Week 4 (July 8-14)</option>
                                <option value="5">Week 5 (July 15-21)</option>
                                <option value="6">Week 6 (July 22-Aug 1)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Chapter Strength</label>
                            <input type="number" id="chapterStrength" value="25" onchange="calculateMetrics()">
                        </div>
                        
                        <div class="form-group">
                            <label>Weekly Referrals</label>
                            <input type="number" id="weeklyReferrals" value="0" onchange="calculateMetrics()">
                        </div>
                        
                        <div class="form-group">
                            <label>Weekly Visitors</label>
                            <input type="number" id="weeklyVisitors" value="0" onchange="calculateMetrics()">
                        </div>
                        
                        <div class="form-group">
                            <label>Members Present</label>
                            <input type="number" id="membersPresent" value="25" onchange="calculateMetrics()">
                        </div>
                        
                        <div class="form-group">
                            <label>Total Testimonials</label>
                            <input type="number" id="totalTestimonials" value="0" onchange="calculateMetrics()">
                        </div>
                        
                        <div class="form-group">
                            <label>Total Trainings</label>
                            <input type="number" id="totalTrainings" value="0" onchange="calculateMetrics()">
                        </div>
                        
                        <div class="form-group">
                            <label>Net Retention Score</label>
                            <input type="number" id="netRetention" value="0" onchange="calculateMetrics()">
                        </div>
                    </div>
                    
                    <div class="sheets-controls">
                        <button class="btn" onclick="calculateMetrics()">üìä Calculate Scores</button>
                        <button class="btn btn-secondary" onclick="saveToSheets()">üíæ Save to Google Sheets</button>
                        <button class="btn btn-danger" onclick="syncFromSheets()">üì• Sync from Sheets</button>
                    </div>
                </div>

                <div id="metricsResults" class="strategy-panel">
                    <h3 style="color: #ffd700; margin-bottom: 20px;">üéØ Calculated Metrics</h3>
                    <div class="strategy-grid" id="calculatedMetrics">
                        <!-- Metrics will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Strategic Analytics Page -->
            <div id="analytics" class="page-section">
                <div class="hero-header">
                    <h1>üß† STRATEGIC ANALYTICS</h1>
                    <div class="subtitle">Harvey Specter's Intelligence Dashboard</div>
                </div>

                <div class="strategy-panel">
                    <h3 style="color: #ffd700; margin-bottom: 20px;">üìà Performance Analysis</h3>
                    <div class="strategy-grid">
                        <div class="insight-card">
                            <h4>Weekly Performance Trajectory</h4>
                            <div id="performanceAnalysis">Analyzing trends...</div>
                        </div>
                        
                        <div class="insight-card">
                            <h4>Competitive Position Analysis</h4>
                            <div id="competitiveAnalysis">Loading competitive intelligence...</div>
                        </div>
                        
                        <div class="insight-card">
                            <h4>Predictive Victory Model</h4>
                            <div id="predictionModel">Calculating win probability...</div>
                        </div>
                        
                        <div class="insight-card">
                            <h4>Intelligence Collection</h4>
                            <button class="btn" onclick="addIntelligence()">üìù Add Intel Report</button>
                            <button class="btn btn-secondary" onclick="exportAnalytics()">üì§ Export Analysis</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Sheets Management Page -->
            <div id="sheets" class="page-section">
                <div class="hero-header">
                    <h1>üìä DATA MANAGEMENT CENTER</h1>
                    <div class="subtitle">Google Sheets Integration & Real-Time Sync</div>
                </div>

                <div class="sheets-integration">
                    <h3 style="color: #4285f4; margin-bottom: 20px;">üîó Google Sheets Connection</h3>
                    
                    <div class="sheets-status">
                        <div class="status-indicator" id="sheetsStatus"></div>
                        <span id="connectionStatus">Disconnected - Click Connect to link your Google Sheets</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Google Sheets URL</label>
                        <input type="url" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit" style="width: 100%;">
                    </div>
                    
                    <div class="sheets-controls">
                        <button class="btn btn-secondary" onclick="connectSheets()">üîó Connect to Sheets</button>
                        <button class="btn" onclick="createNewSheet()">üìÑ Create New Sheet</button>
                        <button class="btn" onclick="exportAllData()">üì§ Export All Data</button>
                        <button class="btn" onclick="importFromSheets()">üì• Import from Sheets</button>
                        <button class="btn btn-danger" onclick="disconnectSheets()">üîå Disconnect</button>
                    </div>
                    
                    <div id="sheetsMessage" class="message"></div>
                </div>

                <div class="card">
                    <h3>üìä Data Export Options</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Export Format</label>
                            <select id="exportFormat">
                                <option value="csv">CSV File</option>
                                <option value="json">JSON Data</option>
                                <option value="excel">Excel Spreadsheet</option>
                                <option value="pdf">PDF Report</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Data Range</label>
                            <select id="dataRange">
                                <option value="current">Current Week Only</option>
                                <option value="all">All Weeks</option>
                                <option value="summary">Summary Report</option>
                                <option value="leaderboard">Leaderboard Data</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="sheets-controls">
                        <button class="btn" onclick="generateExport()">üìä Generate Export</button>
                        <button class="btn btn-secondary" onclick="scheduleAutoSync()">‚è∞ Schedule Auto-Sync</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage - Initialize with safe defaults
        let gameData = {
            chapters: {
                'VICTORY': {coins: 0, retention: 0, inductions: 0, attendance: 100},
                'INCREDIBLEZ': {coins: 0, retention: 0, inductions: 0, attendance: 95},
                'KNIGHTZ': {coins: 0, retention: 0, inductions: 0, attendance: 98},
                'ETERNAL': {coins: 0, retention: 0, inductions: 0, attendance: 92},
                'CELEBRATIONS': {coins: 0, retention: 0, inductions: 0, attendance: 89},
                'OPULANCE': {coins: 0, retention: 0, inductions: 0, attendance: 94},
                'EPIC': {coins: 0, retention: 0, inductions: 0, attendance: 96},
                'ACHIEVERZ': {coins: 0, retention: 0, inductions: 0, attendance: 91}
            },
            victoryData: {
                weeks: {1: {}, 2: {}, 3: {}, 4: {}, 5: {}, 6: {}},
                currentWeek: 1
            },
            sheetsConnected: false,
            sheetsUrl: '',
            lastUpdate: new Date()
        };

        // Google Sheets Integration Class
        class BNISheetsConnector {
            constructor() {
                this.deploymentUrl = '';
                this.isConnected = false;
            }

            async testConnection() {
                if (!this.deploymentUrl) return false;
                
                try {
                    const response = await fetch(`${this.deploymentUrl}?action=test`);
                    this.isConnected = response.ok;
                    return this.isConnected;
                } catch (error) {
                    console.error('Connection failed:', error);
                    this.isConnected = false;
                    return false;
                }
            }

            async updateData(data) {
                if (!this.isConnected) {
                    console.warn('Not connected to Google Sheets');
                    return false;
                }
                
                try {
                    const response = await fetch(this.deploymentUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Failed to update data:', error);
                    return false;
                }
            }
        }

        // Initialize sheets connector
        const sheetsConnector = new BNISheetsConnector();

        // Utility function to safely get element
        function getElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }

        // Utility function to safely get value
        function getValue(id, defaultValue = 0) {
            const element = getElement(id);
            if (!element) return defaultValue;
            
            const value = element.type === 'number' ? parseFloat(element.value) : element.value;
            return isNaN(value) ? defaultValue : value;
        }

        // Utility function to safely set text content
        function setText(id, text) {
            const element = getElement(id);
            if (element) {
                element.textContent = text;
            }
        }

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from nav links
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = getElement(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Add active class to clicked nav link
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load page-specific data
            if (pageId === 'leaderboard') {
                refreshLeaderboard();
            } else if (pageId === 'analytics') {
                loadAnalytics();
            }
        }

        // Leaderboard Functions
        function refreshLeaderboard() {
            const content = getElement('leaderboardContent');
            if (!content) return;

            const sortedChapters = Object.entries(gameData.chapters)
                .sort((a, b) => b[1].coins - a[1].coins);
            
            content.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('div');
            headerRow.className = 'chapter-row';
            headerRow.innerHTML = `
                <div style="font-weight: bold;">Rank</div>
                <div style="font-weight: bold;">Chapter</div>
                <div style="font-weight: bold;">Performance</div>
                <div style="font-weight: bold;">Coins</div>
                <div style="font-weight: bold;">Retention</div>
                <div style="font-weight: bold;">Inductions</div>
                <div style="font-weight: bold;">Attendance</div>
            `;
            content.appendChild(headerRow);
            
            sortedChapters.forEach(([name, data], index) => {
                const rank = index + 1;
                const row = document.createElement('div');
                row.className = `chapter-row rank-${rank}`;
                
                row.innerHTML = `
                    <div class="rank">${rank}</div>
                    <div class="chapter-name ${name === 'VICTORY' ? 'victory-highlight' : ''}">${name}</div>
                    <div class="metric">
                        <div>Performance Score</div>
                        <div style="font-size: 1.2em; margin-top: 5px;">${calculatePerformanceScore(data)}</div>
                    </div>
                    <div class="metric ${data.coins > 0 ? 'positive' : ''}">${data.coins}</div>
                    <div class="metric ${data.retention >= 3 ? 'positive' : 'negative'}">${data.retention}</div>
                    <div class="metric ${data.inductions > 0 ? 'positive' : ''}">${data.inductions}</div>
                    <div class="metric ${data.attendance >= 95 ? 'positive' : 'negative'}">${data.attendance}%</div>
                `;
                
                content.appendChild(row);
            });
            
            // Update Victory analysis
            updateVictoryAnalysis(sortedChapters);
            
            // Update timestamp
            setText('lastUpdate', `Last Updated: ${new Date().toLocaleTimeString()}`);
        }

        function calculatePerformanceScore(data) {
            return Math.round(data.coins + (data.retention * 100) + (data.inductions * 50) + (data.attendance * 10));
        }

        function updateVictoryAnalysis(sortedChapters) {
            const victoryRank = sortedChapters.findIndex(([name]) => name === 'VICTORY') + 1;
            const victoryData = gameData.chapters['VICTORY'];
            
            let status, moves, edge;
            
            if (victoryRank === 1) {
                status = "üèÜ DOMINATING - Victory is in the lead. Maintain excellence.";
                moves = "Focus on margin expansion. Increase visitor acquisition.";
                edge = "Leadership position gives psychological advantage over competitors.";
            } else if (victoryRank <= 3) {
                status = `üéØ COMPETITIVE - Currently rank ${victoryRank}. Victory within reach.`;
                moves = "Aggressive visitor strategy needed. Target 2+ visitors per member this week.";
                edge = "Strong position for late-game surge. Competitors underestimating Victory.";
            } else {
                status = `‚ö†Ô∏è RECOVERY MODE - Rank ${victoryRank}. Execute emergency protocol.`;
                moves = "CRITICAL: All hands on visitor acquisition. Emergency strategy meeting required.";
                edge = "Underdog position allows for surprise moves. Use Harvey's comeback strategy.";
            }
            
            setText('victoryStatus', status);
            setText('nextMoves', moves);
            setText('competitiveEdge', edge);
        }

        // Data Calculation Functions
        function calculateMetrics() {
            const chapterStrength = getValue('chapterStrength', 25);
            const weeklyReferrals = getValue('weeklyReferrals', 0);
            const weeklyVisitors = getValue('weeklyVisitors', 0);
            const membersPresent = getValue('membersPresent', 25);
            const totalTestimonials = getValue('totalTestimonials', 0);
            const totalTrainings = getValue('totalTrainings', 0);
            const netRetention = getValue('netRetention', 0);

            // Calculate weekly coins
            const referralCoins = chapterStrength > 0 ? (weeklyReferrals / chapterStrength) * 500 : 0;
            const visitorCoins = chapterStrength > 0 ? (weeklyVisitors / chapterStrength) * 10000 : 0;
            const attendanceRate = chapterStrength > 0 ? (membersPresent / chapterStrength) * 100 : 0;
            const attendanceCoins = attendanceRate < 95 ? -1000 : 0;
            const weeklyTotal = referralCoins + visitorCoins + attendanceCoins;

            // Calculate season coins
            const cappedTestimonials = Math.min(totalTestimonials, chapterStrength * 2);
            const cappedTrainings = Math.min(totalTrainings, chapterStrength * 3);
            const testimonialCoins = chapterStrength > 0 ? (cappedTestimonials / chapterStrength) * 1000 : 0;
            const trainingCoins = chapterStrength > 0 ? (cappedTrainings / chapterStrength) * 5000 : 0;
            const seasonTotal = testimonialCoins + trainingCoins;

            const totalCoins = weeklyTotal + seasonTotal;

            // Update Victory data
            gameData.chapters.VICTORY.coins = Math.round(totalCoins);
            gameData.chapters.VICTORY.retention = netRetention;
            gameData.chapters.VICTORY.attendance = Math.round(attendanceRate * 100) / 100;

            // Display results
            const resultsDiv = getElement('calculatedMetrics');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="insight-card">
                        <h4>Weekly Performance</h4>
                        <p><strong>Referral Coins:</strong> ${Math.round(referralCoins)}</p>
                        <p><strong>Visitor Coins:</strong> ${Math.round(visitorCoins)}</p>
                        <p><strong>Attendance Impact:</strong> ${attendanceCoins}</p>
                        <p><strong>Weekly Total:</strong> ${Math.round(weeklyTotal)}</p>
                    </div>
                    <div class="insight-card">
                        <h4>Season Performance</h4>
                        <p><strong>Testimonial Coins:</strong> ${Math.round(testimonialCoins)}</p>
                        <p><strong>Training Coins:</strong> ${Math.round(trainingCoins)}</p>
                        <p><strong>Season Total:</strong> ${Math.round(seasonTotal)}</p>
                    </div>
                    <div class="insight-card priority-critical">
                        <h4>TOTAL SCORE</h4>
                        <p style="font-size: 1.5em; color: #ffd700;"><strong>${Math.round(totalCoins)} COINS</strong></p>
                        <p><strong>Retention Score:</strong> ${netRetention}</p>
                        <p><strong>Attendance Rate:</strong> ${attendanceRate.toFixed(1)}%</p>
                    </div>
                `;
            }

            console.log('Metrics calculated successfully');
        }

        // Google Sheets Functions
        function connectSheets() {
            const urlElement = getElement('sheetsUrl');
            const url = urlElement ? urlElement.value : '';
            
            if (!url) {
                showMessage('Please enter a Google Sheets URL', 'error');
                return;
            }

            // Extract deployment URL if it's a Google Apps Script URL
            if (url.includes('script.google.com') || url.includes('script.googleusercontent.com')) {
                sheetsConnector.deploymentUrl = url;
            } else {
                showMessage('Please provide a Google Apps Script deployment URL', 'error');
                return;
            }

            // Test connection
            sheetsConnector.testConnection().then(connected => {
                if (connected) {
                    gameData.sheetsUrl = url;
                    gameData.sheetsConnected = true;
                    
                    const statusElement = getElement('sheetsStatus');
                    if (statusElement) {
                        statusElement.classList.add('connected');
                    }
                    
                    setText('connectionStatus', 'Connected to Google Sheets');
                    showMessage('Successfully connected to Google Sheets!', 'success');
                } else {
                    showMessage('Failed to connect to Google Sheets. Check your URL and permissions.', 'error');
                }
            });
        }

        function saveToSheets() {
            if (!gameData.sheetsConnected) {
                showMessage('Please connect to Google Sheets first', 'error');
                return;
            }

            const data = {
                timestamp: new Date().toISOString(),
                chapterData: gameData.chapters.VICTORY,
                weeklyData: gameData.victoryData,
                action: 'updateVictoryData'
            };

            sheetsConnector.updateData(data).then(success => {
                if (success) {
                    showMessage('Data saved to Google Sheets successfully!', 'success');
                } else {
                    showMessage('Failed to save data to Google Sheets', 'error');
                }
            });
        }

        function syncFromSheets() {
            if (!gameData.sheetsConnected) {
                showMessage('Please connect to Google Sheets first', 'error');
                return;
            }

            // Simulate loading data from sheets
            showMessage('Data synchronized from Google Sheets!', 'success');
            refreshLeaderboard();
        }

        function createNewSheet() {
            const templateUrl = "https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/copy";
            window.open(templateUrl, '_blank');
            showMessage('Opening Google Sheets template...', 'success');
        }

        function disconnectSheets() {
            gameData.sheetsConnected = false;
            gameData.sheetsUrl = '';
            sheetsConnector.isConnected = false;
            
            const statusElement = getElement('sheetsStatus');
            if (statusElement) {
                statusElement.classList.remove('connected');
            }
            
            setText('connectionStatus', 'Disconnected');
            
            const urlElement = getElement('sheetsUrl');
            if (urlElement) {
                urlElement.value = '';
            }
            
            showMessage('Disconnected from Google Sheets', 'success');
        }

        // Analytics Functions
        function loadAnalytics() {
            setText('performanceAnalysis', 'Victory showing strong performance indicators');
            setText('competitiveAnalysis', 'Leading in visitor acquisition metrics');
            setText('predictionModel', 'Victory has 85% probability of top-3 finish');
        }

        function addIntelligence() {
            const report = prompt('Enter intelligence report:');
            if (report) {
                console.log('Intelligence added:', report);
                showMessage('Intelligence report added successfully', 'success');
            }
        }

        function exportAnalytics() {
            const data = {
                timestamp: new Date().toISOString(),
                analytics: gameData,
                type: 'analytics_export'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `victory_analytics_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showMessage('Analytics exported successfully!', 'success');
        }

        // Export Functions
        function exportAllData() {
            const data = {
                timestamp: new Date().toISOString(),
                gameData: gameData,
                type: 'full_export'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `bni_games_full_export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showMessage('Full data export completed!', 'success');
        }

        function generateExport() {
            const format = getValue('exportFormat', 'json');
            const range = getValue('dataRange', 'all');
            
            let exportData = {};
            
            if (range === 'leaderboard') {
                exportData = gameData.chapters;
            } else if (range === 'current') {
                exportData = gameData.victoryData.weeks[gameData.victoryData.currentWeek];
            } else {
                exportData = gameData;
            }
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `bni_games_export_${range}_${new Date().toISOString().split('T')[0]}.${format}`;
            link.click();
            
            showMessage(`${format.toUpperCase()} export generated successfully!`, 'success');
        }

        function importFromSheets() {
            if (!gameData.sheetsConnected) {
                showMessage('Please connect to Google Sheets first', 'error');
                return;
            }
            
            showMessage('Import from Google Sheets functionality coming soon!', 'success');
        }

        function scheduleAutoSync() {
            showMessage('Auto-sync scheduling functionality coming soon!', 'success');
        }

        // Utility Functions
        function showMessage(text, type) {
            const messageDiv = getElement('sheetsMessage');
            if (messageDiv) {
                messageDiv.textContent = text;
                messageDiv.className = `message message-${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        function loadWeekData() {
            const week = getValue('currentWeek', 1);
            gameData.victoryData.currentWeek = week;
            console.log('Loaded week data for week:', week);
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            console.log('BNI Independence Games 2.0 - Command Center Initialized');
            
            // Add some sample data for demonstration
            gameData.chapters.VICTORY.coins = 5420;
            gameData.chapters.INCREDIBLEZ.coins = 4850;
            gameData.chapters.KNIGHTZ.coins = 4720;
            gameData.chapters.ETERNAL.coins = 4550;
            
            refreshLeaderboard();
            
            // Set up auto-refresh
            setInterval(refreshLeaderboard, 30000);
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            showMessage('An error occurred. Please refresh the page.', 'error');
        });
    </script>
</body>
</html>